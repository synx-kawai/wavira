apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wavira.fullname" . }}-config
  labels:
    {{- include "wavira.labels" . | nindent 4 }}
data:
  # MQTT Configuration
  MQTT_HOST: {{ include "wavira.mqttHost" . | quote }}
  MQTT_PORT: {{ include "wavira.mqttPort" . | quote }}
  MQTT_WEBSOCKET_PORT: {{ .Values.config.mqttWebsocketPort | quote }}

  # Database Configuration
  DB_PATH: {{ .Values.config.dbPath | quote }}
  DEVICES_DB_PATH: {{ .Values.config.devicesDbPath | quote }}
  DATA_RETENTION_DAYS: {{ .Values.historyCollector.env.DATA_RETENTION_DAYS | quote }}

  # API Configuration
  API_PORT: {{ .Values.config.apiPort | quote }}
  API_PREFIX: {{ .Values.config.apiPrefix | quote }}

  # Security Configuration
  CORS_ORIGINS: {{ .Values.security.corsOrigins | quote }}
  RATE_LIMIT_ENABLED: {{ .Values.security.rateLimit.enabled | quote }}
  RATE_LIMIT_REQUESTS: {{ .Values.security.rateLimit.requests | quote }}
  RATE_LIMIT_WINDOW: {{ .Values.security.rateLimit.window | quote }}
  ADD_SECURITY_HEADERS: {{ .Values.security.addSecurityHeaders | quote }}
  REQUIRE_API_KEY: {{ .Values.security.requireApiKey | quote }}

  # Logging
  LOG_LEVEL: {{ .Values.historyCollector.env.LOG_LEVEL | quote }}

---
{{- if and .Values.mosquitto.enabled (not .Values.mosquitto.external) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "wavira.fullname" . }}-mosquitto
  labels:
    {{- include "wavira.mosquitto.labels" . | nindent 4 }}
data:
  mosquitto.conf: |
    # Mosquitto MQTT Broker Configuration for Wavira

    # MQTT Listener
    listener {{ .Values.mosquitto.service.mqttPort }} 0.0.0.0
    protocol mqtt

    # WebSocket Listener
    listener {{ .Values.mosquitto.service.websocketPort }} 0.0.0.0
    protocol websockets

    # Authentication
    allow_anonymous {{ .Values.mosquitto.config.allowAnonymous }}
    {{- if .Values.mosquitto.config.passwords }}
    password_file /mosquitto/config/passwords.txt
    {{- end }}

    # Persistence
    persistence true
    persistence_location /mosquitto/data/
    autosave_interval 60

    # Logging
    log_dest stdout
    log_type error
    log_type warning
    log_type notice
    log_type information
    connection_messages true
    log_timestamp true

    # Performance
    max_connections -1
    max_inflight_messages 20
    max_queued_messages 1000
    message_size_limit 0

    # Retained Messages
    retain_available true
{{- end }}
