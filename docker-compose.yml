# Wavira Production Docker Compose
# Wi-Fi CSI based person re-identification and crowd estimation system
#
# Usage:
#   Development:  docker compose up -d
#   Production:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
version: '3.8'

services:
  # ===========================================================================
  # MQTT Broker (Mosquitto)
  # ===========================================================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: wavira-mosquitto
    restart: unless-stopped
    ports:
      - "${MQTT_PORT:-1883}:1883"      # MQTT for ESP32 and services
      - "${MQTT_WS_PORT:-9001}:9001"   # WebSocket for browser clients
    volumes:
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./config/mosquitto/acl.conf:/mosquitto/config/acl.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - wavira-network

  # ===========================================================================
  # History Collector Service
  # Stores CSI data to SQLite, provides REST API, handles device management
  # ===========================================================================
  history-collector:
    build:
      context: .
      dockerfile: docker/Dockerfile.history-collector
    container_name: wavira-history-collector
    restart: unless-stopped
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      mosquitto:
        condition: service_healthy
    volumes:
      - history_data:/app/data
      - ./config/mosquitto:/app/mosquitto_config
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - DB_PATH=/app/data/history.db
      - DEVICES_DB_PATH=/app/data/devices.db
      - MOSQUITTO_CONFIG_DIR=/app/mosquitto_config
      - API_KEY=${API_KEY:-}
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - wavira-network

  # ===========================================================================
  # CSI Processor Service
  # Subscribes to CSI data, performs ML inference, publishes analysis results
  # ===========================================================================
  csi-processor:
    build:
      context: .
      dockerfile: docker/Dockerfile.csi-processor
    container_name: wavira-csi-processor
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
    volumes:
      - ./models:/app/models:ro
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MODEL_PATH=/app/models/crowd_model.pt
      - PYTHONUNBUFFERED=1
    networks:
      - wavira-network

  # ===========================================================================
  # Dashboard (nginx serving static files + reverse proxy)
  # ===========================================================================
  dashboard:
    image: nginx:alpine
    container_name: wavira-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-80}:80"
    volumes:
      - ./tools/csi_visualizer/dashboard_multi.html:/usr/share/nginx/html/dashboard_multi.html:ro
      - ./tools/csi_visualizer/index.html:/usr/share/nginx/html/index.html:ro
      - ./config/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - mosquitto
      - history-collector
    networks:
      - wavira-network

volumes:
  mosquitto_data:
    driver: local
  mosquitto_log:
    driver: local
  history_data:
    driver: local

networks:
  wavira-network:
    driver: bridge
